# Dependency Update Validation Workflow
# Runs comprehensive test suite on all Dependabot PRs
# Ensures IRIS governance + DT calibration tests pass before merge

name: Dependency Update Validation

on:
  pull_request:
    branches:
      - main
      - master
      - develop
    paths:
      - "package.json"
      - "package-lock.json"
      - "analysis/requirements.txt"
      - ".github/workflows/**"

jobs:
  # Job 1: Detect dependency changes
  detect-changes:
    name: Detect Dependency Changes
    runs-on: ubuntu-latest
    outputs:
      iris-updated: ${{ steps.check-iris.outputs.updated }}
      npm-updated: ${{ steps.check-npm.outputs.updated }}
      python-updated: ${{ steps.check-python.outputs.updated }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if @foxruv/iris was updated
        id: check-iris
        run: |
          if git diff HEAD~1 HEAD -- package.json | grep -q '@foxruv/iris'; then
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "::notice::@foxruv/iris dependency was updated"
          else
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if npm packages were updated
        id: check-npm
        run: |
          if git diff HEAD~1 HEAD -- package.json package-lock.json | grep -q .; then
            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if Python packages were updated
        id: check-python
        run: |
          if git diff HEAD~1 HEAD -- analysis/requirements.txt | grep -q .; then
            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

  # Job 2: IRIS Governance Integration Tests
  iris-governance-tests:
    name: IRIS Governance Integration Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.iris-updated == 'true' || needs.detect-changes.outputs.npm-updated == 'true'
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          npm ci
          python -m pip install --upgrade pip
          python -m pip install -r analysis/requirements.txt

      - name: Run IRIS governance integration tests
        run: |
          python -m pytest tests/policy/test_governance_iris_integration.py -v --tb=short

      - name: Run IRIS prod-cycle E2E tests
        run: |
          python -m pytest tests/analysis/test_iris_prod_cycle_integration.py -v --tb=short

  # Job 3: DT Calibration Tests
  dt-calibration-tests:
    name: DT Calibration & Quality Gates Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.python-updated == 'true' || needs.detect-changes.outputs.npm-updated == 'true'
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r analysis/requirements.txt

      - name: Run DT dataset preparation tests
        run: |
          python -m pytest tests/analysis/test_prepare_dt_dataset.py -v --tb=short
          python -m pytest tests/test_prepare_dt_dataset_schema_alignment.py -v --tb=short

      - name: Run DT E2E check tests
        run: |
          python -m pytest tests/analysis/test_dt_e2e_check.py -v --tb=short

      - name: Run DT quality gates tests
        run: |
          python -m pytest tests/analysis/test_publish_dt_gates_summary.py -v --tb=short

      - name: Run DT schema validation
        run: |
          python -m pytest tests/test_dt_schema.py -v --tb=short

  # Job 4: Dashboard Validation
  dashboard-validation:
    name: Dashboard & Metrics Validation
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.npm-updated == 'true'
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run governance dashboard tests
        run: npm run governance:audit || true

      - name: Validate metrics collection
        run: |
          ./scripts/af --help
          echo "Dashboard validation placeholder - add specific tests"

  # Job 5: ReasoningBank public API TS consumer test
  reasoningbank-public-api-test:
    name: ReasoningBank public API TS consumer test
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.npm-updated == 'true' || needs.detect-changes.outputs.iris-updated == 'true'
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ReasoningBank public API TS consumer test
        run: npm run test:reasoningbank-public-api

  # Job 6: Full Test Suite (if IRIS updated)
  full-test-suite:
    name: Full Test Suite
    runs-on: ubuntu-latest
    needs:
      [
        detect-changes,
        iris-governance-tests,
        dt-calibration-tests,
        reasoningbank-public-api-test,
      ]
    if: needs.detect-changes.outputs.iris-updated == 'true'
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install all dependencies
        run: |
          npm ci
          python -m pip install --upgrade pip
          python -m pip install -r analysis/requirements.txt

      - name: Run full test suite
        run: |
          npm test
          python -m pytest tests/ -v --tb=short

      - name: Generate test report
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "All tests completed for IRIS dependency update" >> $GITHUB_STEP_SUMMARY

  # Job 7: Security Scan
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.npm-updated == 'true' || needs.detect-changes.outputs.python-updated == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || echo "::warning::npm audit found vulnerabilities"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run pip safety check
        run: |
          pip install safety
          safety check --json || echo "::warning::safety check found vulnerabilities"

  # Job 8: Approval Gate for Major Updates
  major-update-gate:
    name: Major Update Approval Gate
    runs-on: ubuntu-latest
    needs:
      [
        detect-changes,
        iris-governance-tests,
        dt-calibration-tests,
        full-test-suite,
      ]
    if: needs.detect-changes.outputs.iris-updated == 'true'
    environment:
      name: major-dependency-updates
      url: https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}
    steps:
      - name: Check for major version update
        id: check-major
        run: |
          echo "::notice::This PR updates @foxruv/iris - manual review required"
          echo "::notice::Verify DT calibration and governance dashboards before merging"
          echo "major-update=true" >> $GITHUB_OUTPUT

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **IRIS Dependency Update Detected**\n\n' +
                    'This PR updates `@foxruv/iris`. Before merging:\n\n' +
                    '- [ ] Review IRIS governance test results\n' +
                    '- [ ] Verify DT calibration tests pass\n' +
                    '- [ ] Check dashboard validation\n' +
                    '- [ ] Review upstream release notes\n' +
                    '- [ ] Confirm no breaking changes to governance behavior\n\n' +
                    'See `docs/integrations/IRIS_INTEGRATION.md` for upgrade procedures.'
            })
