# OpenStack Credentials Setup Guide
# NEXT-001: Configure OpenStack credentials for StarlingX deployment
# Created: 2025-12-04T01:42:15Z
# Status: IN PROGRESS

task_id: NEXT-001
priority: P1
estimated_time: 30 minutes
target_completion: 2025-12-04T02:15:00Z

# =============================================================================
# STARLINGX CONNECTION INFO
# =============================================================================
starlingx_connection:
  hostname: stx-aio-0.corp.interface.tag.ooo
  ip_address: "********** (redacted - check your notes or ROAM_TRACKER.yaml line 187)"
  ssh_port: 2222
  ssh_user: rooz  # From rule wrDi0xygSA73Kki7gnvn3l
  identity_file: "pem/starlingx_rsa"  # Per rule dfDJYNXT8kOcgz3nPwBmXE
  
  # SSH config entry (recommended):
  ssh_config: |
    Host stx-aio-0
        HostName **********
        Port 2222
        User rooz
        IdentityFile ~/pem/starlingx_rsa
        ServerAliveInterval 60
        ServerAliveCountMax 3

# =============================================================================
# STEP-BY-STEP CONFIGURATION
# =============================================================================
steps:
  step_1_verify_ssh:
    title: "Verify SSH connectivity to StarlingX"
    description: |
      Test SSH connection before retrieving OpenStack credentials
    
    commands:
      # Option A: Using IP directly
      - ssh -p 2222 -i ~/pem/starlingx_rsa rooz@**********
      
      # Option B: After adding SSH config
      - ssh stx-aio-0
    
    expected_output: "SSH connection successful, shell prompt appears"
    troubleshooting:
      - "If connection refused: Check if port 2222 is open"
      - "If permission denied: Check identity file permissions (chmod 600)"
      - "If host key verification: Add to ~/.ssh/known_hosts or use -o StrictHostKeyChecking=no"
    
    success_criteria: "Can execute commands on StarlingX via SSH"
  
  step_2_retrieve_keystone_endpoint:
    title: "Get OpenStack Keystone auth URL"
    description: |
      Retrieve the authentication endpoint from StarlingX
    
    commands:
      - ssh stx-aio-0 "openstack endpoint list | grep keystone"
      - ssh stx-aio-0 "openstack endpoint show keystone -f value -c publicurl"
    
    expected_output: |
      Example: http://10.10.10.3:5000/v3
      OR: http://192.168.204.1:5000/v3
    
    notes: |
      - Format is typically: http://<controller_ip>:5000/v3
      - Save this as OS_AUTH_URL
      - Port 5000 is standard Keystone
      - /v3 indicates Identity API v3
  
  step_3_get_admin_password:
    title: "Retrieve admin password from StarlingX"
    description: |
      Get the OpenStack admin password stored on StarlingX
    
    commands:
      # Check common password locations
      - ssh stx-aio-0 "sudo cat /etc/keystone/admin-openrc.sh | grep OS_PASSWORD"
      - ssh stx-aio-0 "sudo cat ~/admin-openrc | grep OS_PASSWORD"
      - ssh stx-aio-0 "sudo grep -r 'OS_PASSWORD' /opt/platform/ 2>/dev/null | head -1"
    
    alternative_method: |
      If password files not found, it may be in StarlingX Horizon dashboard:
      1. Access Horizon at http://**********/ (port 80 or 8080)
      2. Login as admin
      3. Navigate to: Project → API Access → Download OpenStack RC File
      4. Extract OS_PASSWORD from downloaded file
    
    security_note: |
      ⚠️ Password is sensitive - store securely
      - Do NOT commit to git
      - Use environment variables
      - Consider using Passbolt or similar
  
  step_4_create_env_file:
    title: "Create .env.openstack with credentials"
    description: |
      Store credentials in local environment file (gitignored)
    
    file_path: ".env.openstack"
    file_content: |
      # OpenStack / StarlingX Credentials
      # Generated: 2025-12-04
      # Source: stx-aio-0.corp.interface.tag.ooo
      
      # Authentication
      export OS_AUTH_URL="http://**********:5000/v3"
      export OS_USERNAME="admin"
      export OS_PASSWORD="<PASSWORD_FROM_STEP_3>"
      export OS_PROJECT_NAME="admin"
      export OS_PROJECT_DOMAIN_NAME="Default"
      export OS_USER_DOMAIN_NAME="Default"
      export OS_REGION_NAME="RegionOne"
      export OS_IDENTITY_API_VERSION=3
      
      # StarlingX Connection
      export STX_HOST="**********"
      export STX_SSH_PORT=2222
      export STX_SSH_USER="rooz"
    
    gitignore_check: |
      Verify .env.openstack is in .gitignore:
      grep -q ".env.openstack" .gitignore || echo ".env.openstack" >> .gitignore
  
  step_5_test_openstack_cli:
    title: "Test OpenStack CLI connectivity"
    description: |
      Verify credentials work with OpenStack CLI
    
    commands:
      # Load credentials
      - source .env.openstack
      
      # Test authentication
      - openstack token issue
      
      # List available resources
      - openstack server list
      - openstack flavor list
      - openstack image list
      - openstack network list
    
    expected_output: |
      Token issued successfully (shows token ID, expires timestamp)
      Lists show current resources or empty lists (no errors)
    
    troubleshooting:
      auth_error: |
        If "401 Unauthorized":
        - Verify OS_AUTH_URL is correct
        - Check OS_PASSWORD is accurate
        - Ensure OS_PROJECT_NAME matches
      
      connection_error: |
        If "Connection refused":
        - Verify port 5000 is accessible from your machine
        - May need VPN or SSH tunnel
        - Test: curl http://**********:5000/v3
      
      version_error: |
        If "API version mismatch":
        - Ensure OS_IDENTITY_API_VERSION=3
        - Some older StarlingX uses v2.0
  
  step_6_update_deploy_script:
    title: "Update deploy.sh to use credentials"
    description: |
      Ensure deployment script sources credentials
    
    file: "scripts/starlingx/deploy.sh"
    
    modification: |
      Add near top of script (after set -euo pipefail):
      
      # Load OpenStack credentials
      if [[ -f "${PROJECT_ROOT}/.env.openstack" ]]; then
          source "${PROJECT_ROOT}/.env.openstack"
          log_info "OpenStack credentials loaded from .env.openstack"
      else
          log_warning ".env.openstack not found - using environment variables"
      fi
    
    verification: |
      bash scripts/starlingx/deploy.sh --dry-run --skip-billing
  
  step_7_document_completion:
    title: "Update SOFT_LAUNCH_ACTION_PLAN.yaml"
    description: |
      Mark NEXT-001 as complete with credentials confirmed
    
    updates:
      - file: ".goalie/SOFT_LAUNCH_ACTION_PLAN.yaml"
        field: "prerequisites_status.openstack_credentials"
        value: "COMPLETE ✅"
      
      - file: ".goalie/SOFT_LAUNCH_ACTION_PLAN.yaml"
        section: "next.NEXT-001"
        add_field: "completion_date"
        value: "2025-12-04T<TIMESTAMP>Z"
    
    commit_message: |
      feat(openstack): Configure StarlingX credentials (NEXT-001)
      
      ✅ OpenStack credentials configured
      - OS_AUTH_URL retrieved from StarlingX
      - Admin password secured in .env.openstack
      - OpenStack CLI tested and validated
      
      Files:
      - .env.openstack (gitignored, contains credentials)
      - .goalie/OPENSTACK_CREDENTIALS_SETUP.yaml (this guide)
      
      Test results:
      - openstack token issue: SUCCESS
      - openstack server list: SUCCESS
      
      Next: NEXT-002 (Dry-run deployment)

# =============================================================================
# QUICK REFERENCE COMMANDS
# =============================================================================
quick_commands:
  connect_starlingx: "ssh -p 2222 -i ~/pem/starlingx_rsa rooz@**********"
  get_auth_url: "ssh stx-aio-0 'openstack endpoint show keystone -f value -c publicurl'"
  get_password: "ssh stx-aio-0 'sudo cat /etc/keystone/admin-openrc.sh | grep OS_PASSWORD'"
  load_credentials: "source .env.openstack"
  test_auth: "openstack token issue"
  test_connectivity: "openstack server list"

# =============================================================================
# SECURITY NOTES
# =============================================================================
security:
  credentials_storage:
    - "✅ Store in .env.openstack (gitignored)"
    - "✅ Use environment variables (export OS_*)"
    - "❌ DO NOT commit passwords to git"
    - "❌ DO NOT share in plaintext"
  
  ssh_keys:
    - "✅ Use dedicated SSH key (~/pem/starlingx_rsa)"
    - "✅ Set permissions: chmod 600 ~/pem/starlingx_rsa"
    - "✅ Add to SSH config for convenience"
  
  password_manager:
    - "Consider storing in Passbolt (per rule lMpSq40GqRhyFf9QkpWiaz)"
    - "PASSBOLT_API_TOKEN placeholder configured"
    - "Can integrate with: https://passbolt.example.com"

# =============================================================================
# TROUBLESHOOTING
# =============================================================================
troubleshooting:
  common_issues:
    issue_1:
      symptom: "SSH connection times out"
      cause: "Network/firewall blocking port 2222"
      solution: |
        - Check if VPN is required
        - Test TCP connectivity: nc -zv ********** 2222
        - Verify IP address is correct
    
    issue_2:
      symptom: "Permission denied (publickey)"
      cause: "SSH key not configured or wrong"
      solution: |
        - Verify key path: ls -la ~/pem/starlingx_rsa
        - Check key permissions: chmod 600 ~/pem/starlingx_rsa
        - Test with password: ssh -p 2222 rooz@********** (if available)
    
    issue_3:
      symptom: "openstack: command not found"
      cause: "Python OpenStackClient not installed"
      solution: |
        - Install: pip3 install python-openstackclient
        - Verify: which openstack
        - Per rule XoRTD3kRAnaFRsM7jIjiPu: Already installed
    
    issue_4:
      symptom: "401 Unauthorized" from OpenStack
      cause: "Incorrect credentials or auth URL"
      solution: |
        - Verify OS_AUTH_URL includes /v3
        - Check OS_PASSWORD is not expired
        - Ensure OS_PROJECT_NAME matches
        - Test direct: curl -i ${OS_AUTH_URL}
    
    issue_5:
      symptom: "Connection refused to port 5000"
      cause: "Keystone not accessible from local machine"
      solution: |
        - May need SSH tunnel: ssh -L 5000:**********:5000 -p 2222 rooz@**********
        - Then use: export OS_AUTH_URL="http://localhost:5000/v3"
        - Or execute openstack commands via SSH directly

# =============================================================================
# COMPLETION CHECKLIST
# =============================================================================
completion_checklist:
  - "[ ] SSH connectivity to StarlingX verified"
  - "[ ] Keystone auth URL retrieved (OS_AUTH_URL)"
  - "[ ] Admin password retrieved (OS_PASSWORD)"
  - "[ ] .env.openstack file created and populated"
  - "[ ] .env.openstack added to .gitignore"
  - "[ ] OpenStack CLI tested: openstack token issue"
  - "[ ] OpenStack CLI tested: openstack server list"
  - "[ ] deploy.sh updated to source .env.openstack"
  - "[ ] Dry-run deployment tested"
  - "[ ] SOFT_LAUNCH_ACTION_PLAN.yaml updated"
  - "[ ] Changes committed to git"

# =============================================================================
# NEXT STEPS AFTER COMPLETION
# =============================================================================
next_steps:
  immediate: "NEXT-002: Execute dry-run deployment"
  command: |
    source .env.openstack
    bash scripts/starlingx/deploy.sh --dry-run --skip-billing --greenfield
  
  expected_duration: "20 minutes"
  success_criteria: |
    - Script runs without errors
    - OpenStack connection verified
    - Deployment plan validated
    - No P0 errors logged
