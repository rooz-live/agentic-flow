---
# PATTERNS.yaml - Single Source of Truth for Pattern Definitions
# This file serves as the authoritative source for all patterns recognized by the Goalie system.
# It is used by:
# - governance_agent.ts (for economic gap analysis)
# - retro_coach.ts (for retrospective insights)
# - goalieGapsProvider.ts (for VS Code extension)
# - suggest_actions.py (for observability action generation)

# Pattern Schema:
#   id: unique pattern identifier (kebab-case)
#   name: human-readable name
#   description: pattern description
#   category: ML | HPC | Stats | Device/Web | General
#   workload_tags: [ML, HPC, Stats, Device/Web] (can be multiple)
#   frameworks: [tensorflow, pytorch, sklearn, etc.] (optional)
#   schedulers: [slurm, k8s, kubernetes] (optional)
#   cod_threshold: default COD threshold for this pattern
#   observability_required: true | false
#   code_fix_available: true | false

patterns:
  # ML Patterns
  - id: ml-training-guardrail
    name: ML Training Guardrail
    description: "Machine learning training guardrails (gradient explosions, NaN batches, early stopping)"
    category: ML
    workload_tags: [ML]
    frameworks: [tensorflow, pytorch]
    schedulers: [k8s, slurm, kubernetes]
    cod_threshold: 6
    observability_required: true
    code_fix_available: true

  - id: distributed-training-failure
    name: Distributed Training Failure
    description: "Multi-node distributed training failures (NCCL timeouts, node crashes)"
    category: ML
    workload_tags: [ML, HPC]
    frameworks: [tensorflow, pytorch]
    schedulers: [k8s, slurm]
    cod_threshold: 6
    observability_required: true
    code_fix_available: false

  - id: mixed-precision-check
    name: Mixed Precision Check
    description: "Mixed precision training issues (FP16 overflow, loss scaling)"
    category: ML
    workload_tags: [ML]
    frameworks: [tensorflow, pytorch]
    schedulers: [k8s, slurm]
    cod_threshold: 6
    observability_required: true
    code_fix_available: false

  - id: gradient-accumulation-mismatch
    name: Gradient Accumulation Mismatch
    description: "Gradient accumulation batch size mismatches across workers"
    category: ML
    workload_tags: [ML]
    frameworks: [tensorflow, pytorch]
    schedulers: [k8s]
    cod_threshold: 6
    observability_required: true
    code_fix_available: false

  - id: checkpoint-corruption
    name: Checkpoint Corruption
    description: "Model checkpoint file corruption or data loss"
    category: ML
    workload_tags: [ML, HPC]
    frameworks: [tensorflow, pytorch]
    schedulers: [slurm]
    cod_threshold: 6
    observability_required: true
    code_fix_available: false

  - id: oom-recovery
    name: OOM Recovery
    description: "Out-of-memory (OOM) kills and recovery strategies"
    category: ML
    workload_tags: [ML]
    frameworks: [tensorflow, pytorch]
    schedulers: [k8s]
    cod_threshold: 6
    observability_required: true
    code_fix_available: false

  - id: tf-distribution-check
    name: TensorFlow Distribution Check
    description: "Distribution shift detection in TensorFlow models"
    category: ML
    workload_tags: [ML, Stats]
    frameworks: [tensorflow]
    schedulers: [k8s]
    cod_threshold: 6
    observability_required: true
    code_fix_available: false

  - id: torch-grad-stability
    name: PyTorch Gradient Stability
    description: "Gradient stability monitoring and clipping in PyTorch"
    category: ML
    workload_tags: [ML]
    frameworks: [pytorch]
    schedulers: [slurm]
    cod_threshold: 6
    observability_required: true
    code_fix_available: false

  - id: batch-norm-instability
    name: Batch Normalization Instability
    description: "Batch normalization instability in distributed training"
    category: ML
    workload_tags: [ML]
    frameworks: [tensorflow, pytorch]
    schedulers: [k8s, slurm]
    cod_threshold: 6
    observability_required: true
    code_fix_available: false

  - id: data-augmentation-overhead
    name: Data Augmentation Overhead
    description: "Data augmentation CPU bottleneck causing GPU idle time"
    category: ML
    workload_tags: [ML]
    frameworks: [tensorflow, pytorch]
    schedulers: [slurm]
    cod_threshold: 6
    observability_required: true
    code_fix_available: false

  - id: learning-rate-instability
    name: Learning Rate Instability
    description: "Learning rate schedule spikes and training divergence"
    category: ML
    workload_tags: [ML]
    frameworks: [pytorch]
    schedulers: [slurm]
    cod_threshold: 6
    observability_required: true
    code_fix_available: false

  # HPC Patterns
  - id: hpc-batch-window
    name: HPC Batch Window
    description: "HPC batch job scheduling windows (queue time, GPU utilization, throughput)"
    category: HPC
    workload_tags: [HPC]
    schedulers: [slurm]
    cod_threshold: 8
    observability_required: true
    code_fix_available: true

  - id: cluster-fragmentation
    name: Cluster Fragmentation
    description: "Cluster resource fragmentation preventing large allocations"
    category: HPC
    workload_tags: [HPC]
    schedulers: [slurm]
    cod_threshold: 8
    observability_required: true
    code_fix_available: false

  - id: network-bottleneck
    name: Network Bottleneck
    description: "Network congestion and InfiniBand degradation in HPC clusters"
    category: HPC
    workload_tags: [HPC]
    schedulers: [slurm]
    cod_threshold: 8
    observability_required: true
    code_fix_available: false

  - id: node-failure-recovery
    name: Node Failure Recovery
    description: "Node failure detection and checkpoint-based recovery"
    category: HPC
    workload_tags: [HPC]
    schedulers: [slurm]
    cod_threshold: 8
    observability_required: true
    code_fix_available: false

  # Stats Patterns
  - id: stat-robustness-sweep
    name: Statistical Robustness Sweep
    description: "Statistical robustness validation (multiple seeds, datasets, p-values)"
    category: Stats
    workload_tags: [Stats]
    frameworks: [sklearn, scipy, statsmodels]
    cod_threshold: 4
    observability_required: true
    code_fix_available: false

  - id: multiple-testing-correction
    name: Multiple Testing Correction
    description: "Multiple hypothesis testing correction (Bonferroni, FDR)"
    category: Stats
    workload_tags: [Stats]
    frameworks: [scipy]
    cod_threshold: 4
    observability_required: true
    code_fix_available: false

  - id: cross-validation-fold-failure
    name: Cross-Validation Fold Failure
    description: "Cross-validation fold failures due to data imbalance"
    category: Stats
    workload_tags: [Stats]
    frameworks: [sklearn]
    cod_threshold: 4
    observability_required: true
    code_fix_available: false

  - id: data-leakage-detection
    name: Data Leakage Detection
    description: "Target variable leakage into features"
    category: Stats
    workload_tags: [Stats]
    frameworks: [sklearn]
    cod_threshold: 4
    observability_required: true
    code_fix_available: false

  - id: outlier-sensitivity
    name: Outlier Sensitivity
    description: "Statistical estimate sensitivity to outliers"
    category: Stats
    workload_tags: [Stats]
    frameworks: [scipy]
    cod_threshold: 4
    observability_required: true
    code_fix_available: false

  - id: sample-size-inadequacy
    name: Sample Size Inadequacy
    description: "Underpowered studies with insufficient sample sizes"
    category: Stats
    workload_tags: [Stats]
    frameworks: [statsmodels]
    cod_threshold: 4
    observability_required: true
    code_fix_available: false

  # Device/Web Patterns
  - id: device-coverage
    name: Device Coverage
    description: "Cross-platform device and browser coverage testing"
    category: Device/Web
    workload_tags: [Device/Web]
    frameworks: [react-native, electron, next.js]
    cod_threshold: 4
    observability_required: true
    code_fix_available: false

  - id: mobile-interaction-lag
    name: Mobile Interaction Lag
    description: "Touch target size and response time issues on mobile"
    category: Device/Web
    workload_tags: [Device/Web]
    frameworks: [react-native]
    cod_threshold: 4
    observability_required: true
    code_fix_available: true

  - id: gesture-conflict
    name: Gesture Conflict
    description: "Conflicting gesture recognizers causing user confusion"
    category: Device/Web
    workload_tags: [Device/Web]
    frameworks: [react-native]
    cod_threshold: 4
    observability_required: true
    code_fix_available: false

  - id: desktop-render-block
    name: Desktop Render Block
    description: "Main thread blocking causing FPS drops in desktop apps"
    category: Device/Web
    workload_tags: [Device/Web]
    frameworks: [electron]
    cod_threshold: 4
    observability_required: true
    code_fix_available: true

  - id: keyboard-shortcut-conflict
    name: Keyboard Shortcut Conflict
    description: "Keyboard shortcuts conflicting with system shortcuts"
    category: Device/Web
    workload_tags: [Device/Web]
    frameworks: [electron]
    cod_threshold: 4
    observability_required: true
    code_fix_available: false

  - id: web-vitals-cls
    name: Web Vitals CLS
    description: "Core Web Vitals issues (CLS, LCP, FID)"
    category: Device/Web
    workload_tags: [Device/Web]
    frameworks: [next.js]
    cod_threshold: 4
    observability_required: true
    code_fix_available: true

  - id: responsive-breakpoint-gap
    name: Responsive Breakpoint Gap
    description: "Missing intermediate breakpoints causing layout breaks"
    category: Device/Web
    workload_tags: [Device/Web]
    frameworks: [tailwind]
    cod_threshold: 4
    observability_required: true
    code_fix_available: false

  - id: image-optimization-missing
    name: Image Optimization Missing
    description: "Unoptimized images causing page weight and LCP issues"
    category: Device/Web
    workload_tags: [Device/Web]
    frameworks: [next.js]
    cod_threshold: 4
    observability_required: true
    code_fix_available: false

  - id: mobile-app-cold-start
    name: Mobile App Cold Start
    description: "Mobile app cold start time exceeding targets"
    category: Device/Web
    workload_tags: [Device/Web]
    frameworks: [react-native]
    cod_threshold: 4
    observability_required: true
    code_fix_available: false

  - id: desktop-app-memory-leak
    name: Desktop App Memory Leak
    description: "Memory leaks causing crashes in long-running desktop sessions"
    category: Device/Web
    workload_tags: [Device/Web]
    frameworks: [electron]
    cod_threshold: 4
    observability_required: true
    code_fix_available: false

  - id: web-prototype-build-time
    name: Web Prototype Build Time
    description: "Web build time exceeding targets (production builds, HMR)"
    category: Device/Web
    workload_tags: [Device/Web]
    frameworks: [vite]
    cod_threshold: 4
    observability_required: true
    code_fix_available: false

  # General Patterns
  - id: safe-degrade
    name: Safe Degrade
    description: "Graceful degradation and fallback strategies"
    category: General
    workload_tags: []
    cod_threshold: 6
    observability_required: true
    code_fix_available: true

  - id: guardrail-lock
    name: Guardrail Lock
    description: "Guardrail enforcement (tests before merge, coverage requirements)"
    category: General
    workload_tags: []
    cod_threshold: 6
    observability_required: true
    code_fix_available: true

  - id: observability-first
    name: Observability First
    description: "Observability-first development practices"
    category: General
    workload_tags: []
    cod_threshold: 6
    observability_required: true
    code_fix_available: true

  - id: iteration-budget
    name: Iteration Budget
    description: "Iteration budget limits to prevent runaway loops"
    category: General
    workload_tags: []
    cod_threshold: 6
    observability_required: true
    code_fix_available: true

  # Enterprise/Orchestration Patterns
  - id: enterprise-ml-pipeline-orchestration
    name: Enterprise ML Pipeline Orchestration
    description: "Multi-stage ML pipeline failures and retries"
    category: ML
    workload_tags: [ML, HPC]
    frameworks: [airflow]
    schedulers: [slurm]
    cod_threshold: 8
    observability_required: true
    code_fix_available: false

  - id: ml-model-serving-latency
    name: ML Model Serving Latency
    description: "ML model serving latency exceeding targets (P50, P95, P99)"
    category: ML
    workload_tags: [ML]
    frameworks: [tensorflow-serving]
    schedulers: [k8s]
    cod_threshold: 6
    observability_required: true
    code_fix_available: false

  - id: data-pipeline-backpressure
    name: Data Pipeline Backpressure
    description: "Kafka consumer lag and backpressure in data pipelines"
    category: HPC
    workload_tags: [HPC]
    frameworks: [kafka]
    cod_threshold: 8
    observability_required: true
    code_fix_available: false

