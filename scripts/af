#!/usr/bin/env bash
#
# af - Agentic Flow Unified Command Interface
#
# Consolidates tool contexts into single interface to reduce friction
# and close Build-Measure-Learn feedback loops.
#
# Usage: af <command> [args]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

show_help() {
    cat <<EOF
${BLUE}af - Agentic Flow Unified Command Interface${NC}

${GREEN}Status & Analysis:${NC}
  af status              Show comprehensive system status
  af metrics             Display metrics dashboard
  af analyze             Run doc_query analysis

${GREEN}Feedback Loop:${NC}
  af insight <text>      Capture retro insight
  af action <title>      Create tracked action item
  af quick-wins          Show Quick Wins progress
  af wsjf                Calculate WSJF priorities

${GREEN}Environment:${NC}
  af snapshot [name]     Create environment snapshot
  af restore [name]      Restore environment snapshot
  af baseline            Capture baseline metrics

${GREEN}Validation:${NC}
  af validate            Run governor validation
  af test                Run concurrent tests
  af governor            Check governor stats
  af governor-health     Validate governor + process tree + BML health

${GREEN}Learning:${NC}
  af hooks               Check hook discoverability
  af events              Show recent learning events
  af beam                Show BEAM dimensions

${GREEN}Build-Measure-Learn:${NC}
  af cycle               Show current BML cycle status
  af commit              Create BML cycle commit
  af feedback            Analyze feedback loops
  af action              Create retro action item
  af suggest-team        Suggest circle teams for NOW items (read-only)
  af suggest-actions     Suggest actions from recent insights (read-only)
  af full-cycle [n]      Run n full BML + health passes (default 1)

${GREEN}Context Reduction:${NC}
  af board               Show Kanban board (NOW/NEXT/LATER)
  af blockers            List active blockers
  af cpu                 Check CPU and governor health

Examples:
  af status                    # Quick health check
  af insight "Reduce CPU load" # Capture retro insight
  af action "Fix IPMI"         # Create tracked action
  af snapshot baseline         # Save current state
  af board                     # Show work in progress

EOF
}

# Status command - comprehensive health check
cmd_status() {
    echo -e "${BLUE}=== Agentic Flow Status ===${NC}\n"

    # Git status
    echo -e "${GREEN}Git:${NC}"
    git --no-pager log --oneline -1
    echo ""

    # AgentDB status
    echo -e "${GREEN}AgentDB:${NC}"
    if [ -f "$PROJECT_ROOT/.agentdb/agentdb.sqlite" ]; then
        echo "  Tables: $(sqlite3 "$PROJECT_ROOT/.agentdb/agentdb.sqlite" "SELECT COUNT(*) FROM sqlite_master WHERE type='table';")"
        echo "  execution_contexts: $(sqlite3 "$PROJECT_ROOT/.agentdb/agentdb.sqlite" "SELECT COUNT(*) FROM execution_contexts;" 2>/dev/null || echo "0")"
        echo "  beam_dimensions: $(sqlite3 "$PROJECT_ROOT/.agentdb/agentdb.sqlite" "SELECT COUNT(*) FROM beam_dimensions;" 2>/dev/null || echo "0")"
    else
        echo "  ❌ AgentDB not found"
    fi
    echo ""

    # Goalie status
    echo -e "${GREEN}Goalie Tracking:${NC}"
    if [ -f "$PROJECT_ROOT/.goalie/KANBAN_BOARD.yaml" ]; then
        local now_count=$(grep -A 20 "NOW:" "$PROJECT_ROOT/.goalie/KANBAN_BOARD.yaml" | grep "- id:" | wc -l | tr -d ' ')
        local next_count=$(grep -A 20 "NEXT:" "$PROJECT_ROOT/.goalie/KANBAN_BOARD.yaml" | grep "- id:" | wc -l | tr -d ' ')
        local done_count=$(grep -A 100 "DONE:" "$PROJECT_ROOT/.goalie/KANBAN_BOARD.yaml" | grep "- id:" | wc -l | tr -d ' ')
        echo "  NOW: $now_count | NEXT: $next_count | DONE: $done_count"
    fi
    echo ""

    # CPU & Governor
    echo -e "${GREEN}System Health:${NC}"
    local load=$(uptime | awk -F'load averages:' '{print $2}' | awk '{print $1}')
    echo "  Load: $load"
    if [ -f "$PROJECT_ROOT/logs/governor_incidents.jsonl" ]; then
        local incidents=$(wc -l < "$PROJECT_ROOT/logs/governor_incidents.jsonl" | tr -d ' ')
        echo "  Governor incidents: $incidents"
    fi
    echo ""

    # Snapshots
    echo -e "${GREEN}Snapshots:${NC}"
    if [ -d "$PROJECT_ROOT/.snapshots" ]; then
        ls -1 "$PROJECT_ROOT/.snapshots" | head -5
    else
        echo "  (no snapshots)"
    fi
}

# Metrics dashboard
cmd_metrics() {
    if [ -f "$PROJECT_ROOT/.goalie/metrics_dashboard.md" ]; then
        cat "$PROJECT_ROOT/.goalie/metrics_dashboard.md"
    else
        echo -e "${YELLOW}Metrics dashboard not found. Run: $SCRIPT_DIR/baseline-metrics.sh${NC}"
    fi
}

# Doc query analysis
cmd_analyze() {
    local query="${1:-BLOCKER|retro|Quick Win}"
    python3 "$SCRIPT_DIR/doc_query.py" "$query"
}

# Capture insight
cmd_insight() {
    local text="$*"
    if [ -z "$text" ]; then
        echo "Usage: af insight <text>"
        exit 1
    fi

    local timestamp=$(date -u +%Y%m%d_%H%M%S)
    echo "{\"timestamp\": \"$timestamp\", \"type\": \"retro_insight\", \"text\": \"$text\"}" | \
        tee -a "$PROJECT_ROOT/.goalie/insights_log.jsonl"
    echo -e "${GREEN}✓ Insight captured${NC}"
}

# Create action item
cmd_action() {
    local title="$*"
    if [ -z "$title" ]; then
        echo "Usage: af action <title>"
        exit 1
    fi

    if [ -f "$SCRIPT_DIR/create_action_item.sh" ]; then
        bash "$SCRIPT_DIR/create_action_item.sh" "$title"
    else
        echo -e "${YELLOW}create_action_item.sh not found${NC}"
        # Fallback: append to CONSOLIDATED_ACTIONS.yaml
        echo "  - title: \"$title\"" >> "$PROJECT_ROOT/.goalie/CONSOLIDATED_ACTIONS.yaml"
        echo -e "${GREEN}✓ Action added to CONSOLIDATED_ACTIONS.yaml${NC}"
    fi
}

# Suggest circle teams for NOW items (read-only)
cmd_suggest_team() {
    echo -e "${BLUE}=== Suggested Circle Teams (NOW lane) ===${NC}\n"
    if [ -f "$SCRIPT_DIR/agentic/suggest_team.py" ]; then
        python3 "$SCRIPT_DIR/agentic/suggest_team.py" || \
            echo -e "${YELLOW}suggest_team.py failed${NC}"
    else
        echo -e "${YELLOW}suggest_team.py not found${NC}"
    fi
}

# Suggest actions from recent insights (read-only)
cmd_suggest_actions() {
    echo -e "${BLUE}=== Suggested Actions from Recent Insights ===${NC}\n"
    if [ -f "$SCRIPT_DIR/agentic/suggest_actions.py" ]; then
        python3 "$SCRIPT_DIR/agentic/suggest_actions.py" || \
            echo -e "${YELLOW}suggest_actions.py failed${NC}"
    else
        echo -e "${YELLOW}suggest_actions.py not found${NC}"
    fi
}

# Quick wins progress
cmd_quick_wins() {
    if [ -f "$SCRIPT_DIR/show_quick_wins_progress.sh" ]; then
        bash "$SCRIPT_DIR/show_quick_wins_progress.sh"
    else
        echo -e "${YELLOW}show_quick_wins_progress.sh not found${NC}"
        if [ -f "$PROJECT_ROOT/docs/QUICK_WINS.md" ]; then
            grep -E "^\- \[.\]" "$PROJECT_ROOT/docs/QUICK_WINS.md" | head -20
        fi
    fi
}

# WSJF calculation
cmd_wsjf() {
    if command -v npx &> /dev/null; then
        cd "$PROJECT_ROOT" && npx goalie@latest recalc-wsjf 2>&1 || echo -e "${YELLOW}goalie not available${NC}"
    else
        echo -e "${YELLOW}npx not found${NC}"
    fi
}

# Environment snapshot
cmd_snapshot() {
    local name="${1:-baseline}"
    bash "$SCRIPT_DIR/restore-environment.sh" --snapshot "$name"
}

# Environment restore
cmd_restore() {
    local name="${1:-baseline}"
    bash "$SCRIPT_DIR/restore-environment.sh" --snapshot "$name"
}

# Baseline metrics
cmd_baseline() {
    bash "$SCRIPT_DIR/baseline-metrics.sh" "$@"
}

# Governor validation
cmd_validate() {
    bash "$SCRIPT_DIR/validate-governor-integration.sh" "$@"
}

# Run tests
cmd_test() {
    if [ -f "$SCRIPT_DIR/run-concurrent-tests.sh" ]; then
        bash "$SCRIPT_DIR/run-concurrent-tests.sh"
    else
        cd "$PROJECT_ROOT" && npm test
    fi
}

# Governor stats
cmd_governor() {
    echo -e "${BLUE}=== Governor Stats ===${NC}\n"
    if [ -f "$PROJECT_ROOT/logs/governor_incidents.jsonl" ]; then
        local total=$(wc -l < "$PROJECT_ROOT/logs/governor_incidents.jsonl" | tr -d ' ')
        local recent=$(tail -10 "$PROJECT_ROOT/logs/governor_incidents.jsonl")
        echo "Total incidents: $total"
        echo ""
        echo "Recent (last 10):"
        echo "$recent" | jq -r '"\(.timestamp) - \(.reason)"' 2>/dev/null || echo "$recent"
    else
        echo "No incidents logged"
    fi
}

# Check hooks
cmd_hooks() {
    echo -e "${BLUE}=== Hook Discoverability ===${NC}\n"
    if [ -d "$PROJECT_ROOT/.agentdb/hooks" ]; then
        find "$PROJECT_ROOT/.agentdb/hooks" -type f
    else
        echo -e "${YELLOW}.agentdb/hooks not found${NC}"
    fi
}

# Learning events
cmd_events() {
    local count="${1:-20}"
    echo -e "${BLUE}=== Recent Learning Events ===${NC}\n"
    if [ -f "$PROJECT_ROOT/logs/learning/events.jsonl" ]; then
        tail -n "$count" "$PROJECT_ROOT/logs/learning/events.jsonl" | jq -r '"\(.timestamp) - \(.event)"' 2>/dev/null
    else
        echo -e "${YELLOW}logs/learning/events.jsonl not found${NC}"
    fi
}

# BEAM dimensions
cmd_beam() {
    echo -e "${BLUE}=== BEAM Dimensions ===${NC}\n"
    if [ -f "$PROJECT_ROOT/.agentdb/agentdb.sqlite" ]; then
        sqlite3 "$PROJECT_ROOT/.agentdb/agentdb.sqlite" \
            "SELECT * FROM beam_dimensions LIMIT 10;" 2>/dev/null || \
            echo "No BEAM dimensions found"
    else
        echo -e "${YELLOW}AgentDB not found${NC}"
    fi
}

# BML cycle status
cmd_cycle() {
    echo -e "${BLUE}=== Build-Measure-Learn Cycle ===${NC}\n"
    if [ -f "$PROJECT_ROOT/.goalie/cycle_log.jsonl" ]; then
        tail -5 "$PROJECT_ROOT/.goalie/cycle_log.jsonl" | jq -r 'select(.type == "BML-CYCLE") | "\(.id) - \(.status)"' 2>/dev/null
    else
        echo "No cycle log found"
    fi
}

# BML commit
cmd_commit() {
    local msg="${*:-BML cycle $(date +%Y%m%d_%H%M%S)}"
    cd "$PROJECT_ROOT"
    git add .goalie/ .agentdb/ logs/ metrics/ 2>/dev/null || true
    git commit -m "$msg" || echo -e "${YELLOW}Nothing to commit${NC}"
}

# Feedback analysis
cmd_feedback() {
    if [ -f "$SCRIPT_DIR/feedback-loop-analyzer.sh" ]; then
        bash "$SCRIPT_DIR/feedback-loop-analyzer.sh"
    else
        echo -e "${YELLOW}feedback-loop-analyzer.sh not found${NC}"
    fi
}

# Full BML + health cycle
cmd_full_cycle() {
    local iterations="${1:-1}"

    case "$iterations" in
        ''|*[!0-9]*)
            echo -e "${YELLOW}Invalid iteration count: $iterations (must be positive integer)${NC}"
            return 1
            ;;
    esac

    if [ "$iterations" -le 0 ]; then
        echo -e "${YELLOW}Iteration count must be > 0${NC}"
        return 1
    fi

    local i
    for i in $(seq 1 "$iterations"); do
        echo -e "${BLUE}=== Full BML + Health Cycle $i/$iterations ===${NC}\n"

        cmd_status
        echo ""
        cmd_board
        echo ""
        cmd_suggest_team
        echo ""
        cmd_metrics
        echo ""
        cmd_cycle
        echo ""
        cmd_governor_health
        echo ""

        if [ -f "$SCRIPT_DIR/doc_query.py" ]; then
            echo -e "${BLUE}=== Circle Roles Snapshot (doc_query) ===${NC}\n"
            python3 "$SCRIPT_DIR/doc_query.py" "Analyst|Assessor|Innovator|Intuitive|Seeker" --max-depth 6 || \
                echo -e "${YELLOW}doc_query.py failed${NC}"
        fi

        cmd_suggest_actions
        echo ""

        # Optional autocommit path behind test-first guardrails
        local do_autocommit="${AF_FULL_CYCLE_AUTOCOMMIT:-0}"
        if [ "$do_autocommit" = "1" ]; then
            echo -e "${BLUE}=== Autocommit Guardrails (iteration $i) ===${NC}\n"

            # Test-first guardrail (can be disabled with AF_FULL_CYCLE_TEST_FIRST=0)
            local run_tests="${AF_FULL_CYCLE_TEST_FIRST:-1}"
            if [ "$run_tests" = "1" ]; then
                echo -e "${BLUE}Running tests via af test...${NC}\n"
                cmd_test
                local test_status=$?
                if [ "$test_status" -ne 0 ]; then
                    echo -e "${RED}Tests failed (status=$test_status); skipping autocommit for this iteration.${NC}"
                    continue
                fi

                echo -e "${BLUE}Running governor validation via af validate...${NC}\n"
                cmd_validate
                local validate_status=$?
                if [ "$validate_status" -ne 0 ]; then
                    echo -e "${RED}Governor validation failed (status=$validate_status); skipping autocommit for this iteration.${NC}"
                    continue
                fi
            fi

            # Only autocommit if there are changes, and warn if there are unsafe ones
            cd "$PROJECT_ROOT"
            local changed
            changed=$(git status --porcelain 2>/dev/null || true)
            if [ -z "$changed" ]; then
                echo -e "${YELLOW}No changes detected; nothing to autocommit.${NC}"
            else
                local unsafe
                unsafe=$(echo "$changed" | awk '{print $2}' | grep -Ev '^(\.goalie/|\.agentdb/|logs/|metrics/)' || true)

                if [ -n "$unsafe" ]; then
                    echo -e "${YELLOW}Unsafe changes detected outside [.goalie, .agentdb, logs, metrics]; autocommit will include only safe paths via cmd_commit.${NC}"
                    echo "$unsafe" | sed 's/^/  - /'
                fi

                echo -e "${GREEN}Creating BML full-cycle auto-commit for safe paths (.goalie, .agentdb, logs, metrics).${NC}"
                cmd_commit "BML full-cycle auto-commit (iteration $i of $iterations)"

                # Optional code-level autocommit under additional guardrails and policy
                local allow_code="${AF_ALLOW_CODE_AUTOCOMMIT:-0}"
                if [ "$allow_code" = "1" ] && [ -f "$PROJECT_ROOT/.goalie/autocommit_policy.yaml" ]; then
                    echo -e "${BLUE}Evaluating code-level autocommit via code_guardrails...${NC}\n"

                    local changed_paths
                    changed_paths=$(echo "$changed" | awk '{print $2}')

                    local safe_code_files
                    safe_code_files=$(printf '%s\n' "$changed_paths" | \
                        python3 "$SCRIPT_DIR/agentic/code_guardrails.py" --filter-code 2>/dev/null || true)

                    if [ -n "$safe_code_files" ]; then
                        echo -e "${GREEN}Staging code files approved by guardrails:${NC}"
                        echo "$safe_code_files" | sed 's/^/  - /'

                        while IFS= read -r f; do
                            [ -n "$f" ] && git add "$f"
                        done <<< "$safe_code_files"

                        git commit -m "BML full-cycle code auto-commit (iteration $i of $iterations)" || \
                            echo -e "${YELLOW}No code changes to commit (code-level).${NC}"
                    else
                        echo -e "${YELLOW}No eligible code files for auto-commit after guardrails.${NC}"
                    fi
                fi
            fi
        fi

        if [ "$i" -lt "$iterations" ]; then
            echo -e "\n${GREEN}--- End of iteration $i ---${NC}\n"
        fi
    done
}

# Kanban board
cmd_board() {
    if [ -f "$PROJECT_ROOT/.goalie/KANBAN_BOARD.yaml" ]; then
        cat "$PROJECT_ROOT/.goalie/KANBAN_BOARD.yaml" | grep -A 50 "NOW:" | head -60
    else
        echo -e "${YELLOW}KANBAN_BOARD.yaml not found${NC}"
    fi
}

# Active blockers
cmd_blockers() {
    python3 "$SCRIPT_DIR/doc_query.py" "BLOCKER-[0-9]+" | head -50
}

# CPU check
cmd_cpu() {
    echo -e "${BLUE}=== CPU & Governor Health ===${NC}\n"
    uptime
    echo ""
    if [ -f "$PROJECT_ROOT/logs/governor_incidents.jsonl" ]; then
        echo "Governor incidents (last 24h): $(find "$PROJECT_ROOT/logs/governor_incidents.jsonl" -mtime -1 -exec wc -l {} \; 2>/dev/null || echo "0")"
    fi
}

# Governor validation + health suite
cmd_governor_health() {
    echo -e "${BLUE}=== Governor Validation & Health Suite ===${NC}\n"

    # 1) Run governor validation
    if [ -f "$SCRIPT_DIR/validate-governor-integration.sh" ]; then
        bash "$SCRIPT_DIR/validate-governor-integration.sh" "$@"
    else
        echo -e "${YELLOW}validate-governor-integration.sh not found${NC}"
    fi

    echo ""

    # 2) Capture a single process tree snapshot
    if [ -f "$SCRIPT_DIR/monitoring/process_tree_watch.js" ]; then
        echo -e "${GREEN}Process tree snapshot (process_tree_watch --once):${NC}"
        node "$SCRIPT_DIR/monitoring/process_tree_watch.js" --once || \
            echo -e "${YELLOW}process_tree_watch.js failed${NC}"
    fi

    echo ""

    # 3) Run BML health check
    if [ -f "$SCRIPT_DIR/agentic/health_check.py" ]; then
        echo -e "${GREEN}BML health check:${NC}"
        python3 "$SCRIPT_DIR/agentic/health_check.py" || \
            echo -e "${YELLOW}health_check.py failed${NC}"
    else
        echo -e "${YELLOW}health_check.py not found${NC}"
    fi
}

# Main dispatch
case "${1:-help}" in
    status) cmd_status ;;
    metrics) cmd_metrics ;;
    analyze) shift; cmd_analyze "$@" ;;
    insight) shift; cmd_insight "$@" ;;
    action) shift; cmd_action "$@" ;;
    suggest-team) shift; cmd_suggest_team "$@" ;;
    suggest-actions) shift; cmd_suggest_actions "$@" ;;
    quick-wins) cmd_quick_wins ;;
    wsjf) cmd_wsjf ;;
    snapshot) shift; cmd_snapshot "$@" ;;
    restore) shift; cmd_restore "$@" ;;
    baseline) shift; cmd_baseline "$@" ;;
    validate) shift; cmd_validate "$@" ;;
    test) cmd_test ;;
    governor) cmd_governor ;;
    governor-health) shift; cmd_governor_health "$@" ;;
    hooks) cmd_hooks ;;
    events) shift; cmd_events "$@" ;;
    beam) cmd_beam ;;
    full-cycle) shift; cmd_full_cycle "${1:-1}" ;;
    cycle) cmd_cycle ;;
    commit) shift; cmd_commit "$@" ;;
    feedback) cmd_feedback ;;
    board) cmd_board ;;
    blockers) cmd_blockers ;;
    cpu) cmd_cpu ;;
    help|--help|-h) show_help ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run 'af help' for usage"
        exit 1
        ;;
esac
